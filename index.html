<!DOCTYPE html>

<html lang="en">

<head>

  <meta charset="UTF-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <title>Book an Appointment â€“ TailorMe</title>

  <link rel="stylesheet" href="appointment.css" />

  <!-- âœ… PATCH (ONLY): move title down + brighten page (safe overlay) -->
  <style>
    /* Brighten the whole page slightly without touching your CSS file */
    body { position: relative; }
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events: none;
      /* subtle light lift */
      background: rgba(255,255,255,0.06);
      mix-blend-mode: screen;
      z-index: 0;
    }
    /* keep all content above overlay */
    .tm-header, .tm-main, .tm-footer { position: relative; z-index: 1; }

    /* Move the card/title down a bit from top */
    .tm-card { margin-top: 22px; }
    .tm-title { margin-top: 10px; }
    .tm-subtitle { margin-top: 10px; }
  </style>

</head>

<body>

  <header class="tm-header">

    <div class="tm-brand">

      <span class="tm-logo">ðŸ‘‘</span>

      <span class="tm-name">TailorMe</span>

    </div>

  </header>



  <main class="tm-main">

    <section class="tm-card">

      <h1 class="tm-title">Book an Appointment</h1>

      <p class="tm-subtitle">Mobile Alterations & Custom Tailoring</p>



      <form id="appointmentForm" novalidate>

        <div class="grid">

          <label class="field">

            <span>Name</span>

            <input type="text" id="name" name="name" required />

          </label>



          <label class="field">

            <span>Email</span>

            <input type="email" id="email" name="email" required inputmode="email" autocomplete="email"
                   pattern="^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$" />

          </label>



          <label class="field">

            <span>Phone</span>

            <input type="tel" id="phone" name="phone" required />

          </label>



          <label class="field full">

            <span>Address</span>

            <input type="text" id="address" name="address" required />

          </label>



          <label class="field">

            <span>Service Type</span>

            <select id="service" name="service" required>

              <option value="">-- Select --</option>

              <option value="Alteration">Alteration</option>

              <option value="Custom">Custom</option>

            </select>

          </label>



          <label class="field">

            <span>Number of Pieces</span>

            <input type="number" min="1" id="pieces" name="pieces" required />

          </label>



          <label class="field">

            <span>Pickup Date</span>

            <input type="date" id="pickup_date" name="pickup_date" required />

          </label>



          <label class="field">

            <span>Pickup Time</span>

            <input type="time" id="pickup_time" name="pickup_time" required />

          </label>



          <label class="field full">

            <span>Additional Notes (optional)</span>

            <textarea id="notes" name="notes" rows="3" placeholder="Any special instructions..."></textarea>

          </label>

        </div>



        <button class="tm-btn" id="submitBtn" type="submit">Submit Booking</button>

        <p id="status" class="status" role="status" aria-live="polite"></p>

      </form>

    </section>

  </main>



  <footer class="tm-footer">

    <small>Â© <span id="year"></span> TailorMe â€” Louisville, KY</small>

  </footer>



  <script>

    // === Google Apps Script Web App (TailorMe Booking) ===
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwCoG_JRmDASWhnrFX0f98rMWUOIbKVzs6eyCBkNU_t7YAuQVmRfoPdNqPqfvL1EEm4/exec';

    // === Thank you page ===
    const THANK_YOU_URL = 'https://tailorme.me/thank-you.html';

    // === Stripe Payment Link (TEST) ===
    const STRIPE_PAYMENT_LINK = 'https://buy.stripe.com/test_00w28q55Z7by14wbb64Ni00';

    // Session key to hold form before payment
    const PENDING_KEY = 'tm_pending_booking_v1';

    const $ = s => document.querySelector(s);
    document.getElementById('year').textContent = new Date().getFullYear();
    const form = $('#appointmentForm'), statusEl = $('#status'), submitBtn = $('#submitBtn');

    function showStatus(msg, ok=true){
      statusEl.textContent = msg;
      statusEl.style.color = ok ? '#c1ffd6' : '#ffb3b3';
    }

    async function goThankYou(){
      try {
        const r = await fetch(THANK_YOU_URL, { method: 'HEAD', cache: 'no-store' });
        if (r.ok) window.location.replace(THANK_YOU_URL);
        else {
          showStatus('âœ… Booking received. Confirmation email sent.', true);
          form.reset();
          submitBtn.disabled = false;
        }
      } catch {
        showStatus('âœ… Booking received. Check your email & Sheet.', true);
        form.reset();
        submitBtn.disabled = false;
      }
    }

    function getPayloadFromForm(){
      return {
        name: $('#name').value.trim(),
        email: $('#email').value.trim(),
        phone: $('#phone').value.trim(),
        address: $('#address').value.trim(),
        service: $('#service').value,
        pieces: $('#pieces').value.trim(),
        pickup_date: $('#pickup_date').value,
        pickup_time: $('#pickup_time').value,
        notes: $('#notes').value.trim()
      };
    }

    function validatePayload(payload){
      const req = ['name','email','phone','address','service','pieces','pickup_date','pickup_time'];
      for (const k of req){
        if(!payload[k]) return { ok:false, msg:'Please fill all required fields.' };
      }
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(payload.email)){
        return { ok:false, msg:'Please enter a valid email.' };
      }
      return { ok:true };
    }

    async function sendToWebApp(payload){
      // Attempt 1: normal POST
      try {
        const res = await fetch(WEB_APP_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        if (data && data.ok) return true;
        throw new Error('Unexpected response');
      } catch {
        // Attempt 2: no-cors fallback
        try {
          await fetch(WEB_APP_URL, {
            method:'POST',
            mode:'no-cors',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          return true;
        } catch {
          return false;
        }
      }
    }

    // ===========================
    // 1) If user returned from Stripe with ?paid=1
    // ===========================
    (async function handlePaidReturn(){
      const params = new URLSearchParams(window.location.search);
      const paid = params.get('paid');
      const canceled = params.get('canceled');

      if (canceled === '1') {
        showStatus('Payment canceled. You can try again anytime.', false);
        return;
      }

      if (paid === '1') {
        submitBtn.disabled = true;
        showStatus('Payment received. Finalizing your bookingâ€¦');

        let payload = null;
        try {
          payload = JSON.parse(sessionStorage.getItem(PENDING_KEY) || 'null');
        } catch { payload = null; }

        if (!payload) {
          showStatus('âœ… Payment done. Please re-submit the form (we could not find your saved details).', false);
          submitBtn.disabled = false;
          return;
        }

        const sent = await sendToWebApp(payload);
        if (!sent) {
          showStatus('âŒ Payment done, but booking could not be sent. Please contact contact@tailorme.me.', false);
          submitBtn.disabled = false;
          return;
        }

        // clear & go thank you
        sessionStorage.removeItem(PENDING_KEY);
        goThankYou();
      }
    })();

    // ===========================
    // 2) Normal submit: validate -> save -> redirect to Stripe
    // ===========================
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const payload = getPayloadFromForm();
      const v = validatePayload(payload);
      if (!v.ok){
        showStatus(v.msg, false);
        submitBtn.disabled = false;
        return;
      }

      showStatus('Redirecting to secure paymentâ€¦');
      submitBtn.disabled = true;

      // Save details before payment
      sessionStorage.setItem(PENDING_KEY, JSON.stringify(payload));

      // Go to Stripe Payment Link
      window.location.href = STRIPE_PAYMENT_LINK;
    });

  </script>

</body>

</html>
